version: "3.8"

services:
  wsi_service:
    build:
      target: wsi_service_dev
    command:
      [
        "sh",
        "-c",
        "poetry run python -m debugpy --listen 0.0.0.0:5678 -m uvicorn wsi_service.app:app --reload --host 0.0.0.0 --loop=uvloop --http=httptools --port 8080"
      ]
    ports:
      - 5678:5678
      - 8080:8080
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - WS_INACTIVE_HISTO_IMAGE_TIMEOUT_SECONDS=5
      - WS_IMAGE_HANDLE_CACHE_SIZE=6

      - WS_CORS_ALLOW_CREDENTIALS=False
      - WS_CORS_ALLOW_ORIGINS=["*"]
      - WS_DISABLE_OPENAPI=False
      - WS_MAPPER_ADDRESS=
      - WS_LOCAL_MODE=wsi_service.simple_mapper:SimpleMapper
      - WS_API_V3_INTEGRATION=wsi_service.api.v3.integrations.empaia:EmpaiaApiIntegration
      - WS_IDP_URL=http://host.docker.internal:9003/auth/realms/xopat
      - WS_CLIENT_ID=xopat-client
      - WS_ORGANIZATION_ID=xopat
      - WS_DEBUG=True
      - WS_CLIENT_SECRET=
      - WS_AUDIENCE=xopat-client
      - WS_OPENAPI_AUTH_URL=http://host.docker.internal:9003/auth/realms/xopat/protocol/openid-connect/auth
      - WS_OPENAPI_TOKEN_URL=http://host.docker.internal:9003/auth/realms/xopat/protocol/openid-connect/token
      - WS_REWRITE_URL_IN_WELLKNOWN=http://host.docker.internal:9003/auth/realms/xopat
      - WS_REFRESH_INTERVAL=300
    volumes:
      - .:/wsi-service
      - ${COMPOSE_DATA_DIR}:/data